# ========================================
# API GATEWAY CONFIGURATION
# ========================================
spring:
  application:
    name: api-gateway

  # ========================================
  # REDIS CONFIGURATION (Reactive)
  # ========================================
  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:}
      database: 0
      timeout: 2000ms
      lettuce:
        pool:
          max-active: 20
          max-idle: 10
          min-idle: 2
          max-wait: -1ms

  # ========================================
  # CLOUD GATEWAY CONFIGURATION
  # ========================================
  cloud:
    gateway:
      # HTTP Client Configuration
      httpclient:
        connect-timeout: 5000
        response-timeout: 10s

      # Global CORS Configuration
      globalcors:
        cors-configurations:
          '[/**]':
            allowed-origins:
              - "http://localhost:3000"
              - "http://localhost:4200"
              - "http://localhost:5173"
            allowed-methods:
              - GET
              - POST
              - PUT
              - DELETE
              - OPTIONS
              - PATCH
            allowed-headers: "*"
            allow-credentials: true
            max-age: 3600

server:
  port: ${GATEWAY_PORT:8080}

# ========================================
# JWT CONFIGURATION
# ========================================
jwt:
  secret: ${JWT_SECRET}

# ========================================
# EUREKA CLIENT CONFIGURATION
# ========================================
eureka:
  client:
    service-url:
      defaultZone: ${EUREKA_URL:http://localhost:8761/eureka/}
    fetch-registry: true
    register-with-eureka: true

  instance:
    prefer-ip-address: true
    instance-id: ${spring.application.name}:${server.port}
    metadata-map:
      zone: primary
      version: 1.0.0

# ========================================
# RESILIENCE4J - CIRCUIT BREAKER
# ========================================
resilience4j:
  circuitbreaker:
    instances:
      # Auth Service Circuit Breaker
      authServiceCircuitBreaker:
        sliding-window-size: 10
        minimum-number-of-calls: 5
        failure-rate-threshold: 50
        wait-duration-in-open-state: 30s
        permitted-number-of-calls-in-half-open-state: 3
        slow-call-rate-threshold: 100
        slow-call-duration-threshold: 3s

      # Account Service Circuit Breaker
      accountServiceCircuitBreaker:
        sliding-window-size: 10
        minimum-number-of-calls: 5
        failure-rate-threshold: 50
        wait-duration-in-open-state: 30s
        permitted-number-of-calls-in-half-open-state: 3

      # Transaction Service Circuit Breaker
      transactionServiceCircuitBreaker:
        sliding-window-size: 10
        minimum-number-of-calls: 5
        failure-rate-threshold: 50
        wait-duration-in-open-state: 30s
        permitted-number-of-calls-in-half-open-state: 3

  # Time Limiter Configuration
  timelimiter:
    instances:
      authServiceCircuitBreaker:
        timeout-duration: 5s
        cancel-running-future: true

      accountServiceCircuitBreaker:
        timeout-duration: 5s
        cancel-running-future: true

      transactionServiceCircuitBreaker:
        timeout-duration: 5s
        cancel-running-future: true

# ========================================
# ACTUATOR CONFIGURATION
# ========================================
management:
  endpoints:
    web:
      exposure:
        include: health,info,gateway,circuitbreakers,metrics
  endpoint:
    health:
      show-details: always
    gateway:
      enabled: true

# ========================================
# LOGGING CONFIGURATION
# ========================================
logging:
  level:
    root: INFO
    com.JK.FinIce.apigateway: DEBUG
    org.springframework.cloud.gateway: DEBUG
    org.springframework.cloud.gateway.filter.GatewayMetricsFilter: WARN
    reactor.netty: INFO